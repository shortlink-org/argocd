################################################################################
# PROMETHEUS-OPERATOR · fan-out one child pipeline per CRD
################################################################################
prometheus-operator:crd:
  extends: .matrix_deploy_provider
  stage: deploy

  # Parent job forks once for each CRD row ↓
  parallel:
    matrix:
      - CRD_URL: https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.83.0/example/prometheus-operator-crd/monitoring.coreos.com_alertmanagerconfigs.yaml
        CRD_APPLYSET: alertmanagerconfigs
      - CRD_URL: https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.83.0/example/prometheus-operator-crd/monitoring.coreos.com_alertmanagers.yaml
        CRD_APPLYSET: alertmanagers
      - CRD_URL: https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.83.0/example/prometheus-operator-crd/monitoring.coreos.com_podmonitors.yaml
        CRD_APPLYSET: podmonitors
      - CRD_URL: https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.83.0/example/prometheus-operator-crd/monitoring.coreos.com_probes.yaml
        CRD_APPLYSET: probes
      - CRD_URL: https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.83.0/example/prometheus-operator-crd/monitoring.coreos.com_prometheusagents.yaml
        CRD_APPLYSET: prometheusagents
      - CRD_URL: https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.83.0/example/prometheus-operator-crd/monitoring.coreos.com_prometheuses.yaml
        CRD_APPLYSET: prometheuses
      - CRD_URL: https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.83.0/example/prometheus-operator-crd/monitoring.coreos.com_prometheusrules.yaml
        CRD_APPLYSET: prometheusrules
      - CRD_URL: https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.83.0/example/prometheus-operator-crd/monitoring.coreos.com_scrapeconfigs.yaml
        CRD_APPLYSET: scrapeconfigs
      - CRD_URL: https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.83.0/example/prometheus-operator-crd/monitoring.coreos.com_servicemonitors.yaml
        CRD_APPLYSET: servicemonitors
      - CRD_URL: https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.83.0/example/prometheus-operator-crd/monitoring.coreos.com_thanosrulers.yaml
        CRD_APPLYSET: thanosrulers

  # Variables available to every matrix row
  variables:
    KUBE_CONTEXT: shortlink-org/argocd:${PROVIDER}

  trigger:
    include:
      - component: $CI_SERVER_FQDN/shortlink-org/gitlab-templates/crd@main
        inputs:
          kube_context: $KUBE_CONTEXT
          applyset:     $CRD_APPLYSET
          manifest:     $CRD_URL
    strategy: depend     # parent waits for all child pipelines

  needs: [ ]
  rules:
    - when: manual

################################################################################
# ISTIO · one child pipeline for the bundle
################################################################################
istio:crd:
  extends: .matrix_deploy_provider
  stage: deploy

  variables:
    KUBE_CONTEXT: shortlink-org/argocd:${PROVIDER}

  trigger:
    include:
      - component: $CI_SERVER_FQDN/shortlink-org/gitlab-templates/crd@main
        inputs:
          kube_context: $KUBE_CONTEXT
          applyset:     istio
          manifest:     https://raw.githubusercontent.com/istio/istio/master/manifests/charts/base/crds/crd-all.gen.yaml
    strategy: depend

  needs: [ ]
  rules:
    - when: manual
